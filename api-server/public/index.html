<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPPConnect Pro Manager</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-danger: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-dark: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a35;
            --bg-card: #252547;
            --bg-hover: #2d2d5f;
            
            --text-primary: #ffffff;
            --text-secondary: #b8b8d4;
            --text-muted: #6a6a8e;
            
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 90%, rgba(56, 239, 125, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header Styles */
        .header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 42px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 14px 28px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .tab.active {
            color: var(--text-primary);
            border-color: transparent;
            box-shadow: var(--shadow-md);
        }

        .tab.active::before {
            opacity: 1;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        /* Card Styles */
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .card h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--gradient-primary);
            padding: 28px;
            border-radius: var(--radius-md);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .stat-value {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 15px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Button Styles */
        button {
            background: var(--gradient-primary);
            color: var(--text-primary);
            border: none;
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 13px;
            width: auto;
            margin: 0 5px 5px 0;
            display: inline-block;
        }

        .btn-success {
            background: var(--gradient-success);
        }

        .btn-danger {
            background: var(--gradient-danger);
        }

        .btn-info {
            background: var(--gradient-info);
        }

        /* Item Cards */
        .agent-item, .webhook-item, .note-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .agent-item:hover, .webhook-item:hover, .note-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateX(4px);
        }

        .agent-item h3, .webhook-item h3 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .agent-item p, .webhook-item p {
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .agent-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .status-online {
            background: #38ef7d;
            color: #38ef7d;
        }

        .status-offline {
            background: #6a6a8e;
            color: #6a6a8e;
        }

        .status-busy {
            background: #ff6a00;
            color: #ff6a00;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 20px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            display: none;
            z-index: 2000;
            min-width: 350px;
            max-width: 450px;
        }

        .notification.show {
            display: block;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(500px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.realtime {
            border-left: 4px solid #667eea;
        }

        .notification.error {
            border-left: 4px solid #ee0979;
        }

        .notification.success {
            border-left: 4px solid #38ef7d;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Chart Container */
        canvas {
            max-height: 350px;
            border-radius: var(--radius-md);
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                padding: 24px;
            }

            h1 {
                font-size: 32px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .tabs {
                gap: 8px;
            }

            .tab {
                padding: 10px 18px;
                font-size: 13px;
            }

            .notification {
                min-width: auto;
                max-width: calc(100vw - 40px);
                right: 20px;
                top: 20px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üì± WPPConnect Pro Manager</h1>
                <p class="subtitle">Advanced Analytics ‚Ä¢ Team Management ‚Ä¢ Webhooks ‚Ä¢ CRM Integration</p>
                
                <div class="tabs">
                    <button class="tab active" onclick="showTab('analytics')">üìä Analytics</button>
                    <button class="tab" onclick="showTab('messaging')">üí¨ Messaging</button>
                    <button class="tab" onclick="showTab('agents')">üë• Team</button>
                    <button class="tab" onclick="showTab('webhooks')">üîî Webhooks</button>
                    <button class="tab" onclick="showTab('crm')">üîó CRM</button>
                    <button class="tab" onclick="showTab('export')">üì§ Export</button>
                    <button class="tab" onclick="showTab('sessions')">üìã Sessions</button>
                </div>
            </div>
        </div>

        <!-- EXPORT TAB -->
        <div id="export-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üì§ Export Conversations</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="exportConvSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="export-buttons">
                        <button onclick="exportData('conversations', 'csv')" class="btn-small btn-info">Export CSV</button>
                        <button onclick="exportData('conversations', 'json')" class="btn-small btn-success">Export JSON</button>
                    </div>
                </div>

                <div class="card">
                    <h2>üì§ Export Messages</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="exportMsgSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Specific Chat (Optional)</label>
                        <input type="text" id="exportChatId" placeholder="201234567890@c.us">
                    </div>
                    <div class="export-buttons">
                        <button onclick="exportData('messages', 'csv')" class="btn-small btn-info">Export CSV</button>
                        <button onclick="exportData('messages', 'json')" class="btn-small btn-success">Export JSON</button>
                    </div>
                </div>

                <div class="card">
                    <h2>üì§ Export Contacts</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="exportContactSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="export-buttons">
                        <button onclick="exportData('contacts', 'csv')" class="btn-small btn-info">Export CSV</button>
                        <button onclick="exportData('contacts', 'json')" class="btn-small btn-success">Export JSON</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SESSIONS TAB -->
        <div id="sessions-tab" class="tab-content">
            <div class="card">
                <h2>üìã Active Sessions</h2>
                <div id="sessionsList" class="loading">Loading sessions...</div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notification" class="notification"></div>
    <div id="realtimeNotification" class="notification realtime"></div>

    <script>
        const API_URL = 'http://localhost:3000';
        const socket = io(API_URL);
        let currentSession = null;
        let messagesChart = null;

        // WebSocket Events
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
        });

        socket.on('new_message', (data) => {
            showRealtimeNotification(`üí¨ New message from ${data.from}`, 'info');
            if (currentSession) loadAnalytics();
        });

        socket.on('session_status', (data) => {
            showRealtimeNotification(`üì± ${data.sessionName}: ${data.status}`, 'info');
            loadSessions();
        });

        socket.on('conversation_assigned', (data) => {
            showRealtimeNotification(`‚úÖ Assigned to ${data.agent}`, 'success');
        });

        socket.on('conversation_transferred', (data) => {
            showRealtimeNotification(`üîÑ Transferred to ${data.toAgent}`, 'info');
        });

        // Notification Functions
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => notification.className = 'notification', 4000);
        }

        function showRealtimeNotification(message, type = 'info') {
            const notification = document.getElementById('realtimeNotification');
            notification.textContent = message;
            notification.className = `notification realtime show ${type}`;
            setTimeout(() => notification.className = 'notification realtime', 5000);
        }

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Load Sessions
        async function loadSessions() {
            try {
                const response = await fetch(`${API_URL}/sessions`);
                const data = await response.json();

                const selects = [
                    'analyticsSession', 'messageSession', 'fileSession', 'agentSession',
                    'viewAgentsSession', 'webhookSession', 'viewWebhooksSession',
                    'crmSession', 'bulkCrmSession', 'viewCrmSession', 'noteSession',
                    'exportConvSession', 'exportMsgSession', 'exportContactSession'
                ];

                if (data.sessions && data.sessions.length > 0) {
                    const options = data.sessions
                        .filter(s => s.status === 'connected')
                        .map(s => `<option value="${s.session_name}">${s.session_name} ${s.phone_number ? '(' + s.phone_number + ')' : ''}</option>`)
                        .join('');
                    
                    selects.forEach(id => {
                        const select = document.getElementById(id);
                        if (select) {
                            select.innerHTML = '<option value="">Choose a session...</option>' + options;
                        }
                    });

                    // Update sessions list
                    document.getElementById('sessionsList').innerHTML = data.sessions.map(s => {
                        const statusColor = s.status === 'connected' ? '#38ef7d' : '#ee0979';
                        return `
                            <div class="agent-item">
                                <h3>
                                    <span class="agent-status" style="background: ${statusColor}; color: ${statusColor};"></span>
                                    ${s.session_name}
                                    <span style="color: ${statusColor}; font-size: 14px; margin-left: 12px;">
                                        ${s.status.toUpperCase()}
                                    </span>
                                </h3>
                                <p>üì± Phone: ${s.phone_number || 'Not connected'}</p>
                                <p>üïê Created: ${new Date(s.created_at).toLocaleString()}</p>
                                <button class="btn-small btn-danger" onclick="closeSession('${s.session_name}')">Close Session</button>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showNotification('Failed to load sessions', 'error');
            }
        }

        // Analytics Functions
        async function loadAnalytics() {
            const session = document.getElementById('analyticsSession').value;
            if (!session) {
                showNotification('Please select a session', 'error');
                return;
            }

            currentSession = session;
            socket.emit('subscribe', session);

            try {
                // Load summary stats
                const summaryRes = await fetch(`${API_URL}/sessions/${session}/analytics/summary`);
                const summary = await summaryRes.json();

                document.getElementById('analyticsOverview').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${summary.totalMessages || 0}</div>
                        <div class="stat-label">Total Messages</div>
                    </div>
                    <div class="stat-card" style="background: var(--gradient-success);">
                        <div class="stat-value">${summary.totalContacts || 0}</div>
                        <div class="stat-label">Total Contacts</div>
                    </div>
                    <div class="stat-card" style="background: var(--gradient-info);">
                        <div class="stat-value">${summary.activeConversations || 0}</div>
                        <div class="stat-label">Active Chats</div>
                    </div>
                    <div class="stat-card" style="background: var(--gradient-danger);">
                        <div class="stat-value">${summary.avgResponseTime || 0}s</div>
                        <div class="stat-label">Avg Response</div>
                    </div>
                `;

                // Load daily metrics
                const metricsRes = await fetch(`${API_URL}/sessions/${session}/analytics/daily?days=30`);
                const metricsData = await metricsRes.json();
                updateChart(metricsData.metrics || []);

                // Load agent performance
                const agentRes = await fetch(`${API_URL}/sessions/${session}/analytics/agent-performance`);
                const agentData = await agentRes.json();

                document.getElementById('agentPerformance').innerHTML = agentData.agents && agentData.agents.length > 0
                    ? agentData.agents.map(a => `
                        <div class="agent-item">
                            <h3>${a.name}</h3>
                            <p>‚úÖ Active: ${a.active_conversations || 0} | üì¶ Closed: ${a.closed_conversations || 0}</p>
                            <p>‚≠ê Rating: ${a.avg_rating ? a.avg_rating.toFixed(1) : 'N/A'}</p>
                        </div>
                    `).join('')
                    : '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No agent data available</p>';

            } catch (error) {
                console.error('Error loading analytics:', error);
                showNotification('Failed to load analytics', 'error');
            }
        }

        function updateChart(metrics) {
            const ctx = document.getElementById('messagesChart').getContext('2d');
            
            if (messagesChart) {
                messagesChart.destroy();
            }

            const dates = metrics.map(m => m.date).reverse();
            const sent = metrics.map(m => m.messages_sent || 0).reverse();
            const received = metrics.map(m => m.messages_received || 0).reverse();

            messagesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Sent',
                        data: sent,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }, {
                        label: 'Received',
                        data: received,
                        borderColor: '#38ef7d',
                        backgroundColor: 'rgba(56, 239, 125, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#ffffff',
                                font: { size: 14, weight: 'bold' },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#b8b8d4' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#b8b8d4' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // Session Management
        async function createSession() {
            const sessionName = document.getElementById('newSessionName').value.trim();
            if (!sessionName) {
                showNotification('Please enter a session name', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionName })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Session created successfully!', 'success');
                    document.getElementById('newSessionName').value = '';
                    setTimeout(loadSessions, 3000);
                }
            } catch (error) {
                showNotification('Failed to create session', 'error');
            }
        }

        async function closeSession(sessionName) {
            if (!confirm(`Are you sure you want to close "${sessionName}"?`)) return;

            try {
                await fetch(`${API_URL}/sessions/${sessionName}`, { method: 'DELETE' });
                showNotification('Session closed successfully', 'success');
                loadSessions();
            } catch (error) {
                showNotification('Failed to close session', 'error');
            }
        }

        // Messaging Functions
        async function sendMessage() {
            const session = document.getElementById('messageSession').value;
            const recipient = document.getElementById('recipientNumber').value.trim();
            const message = document.getElementById('messageText').value.trim();

            if (!session || !recipient || !message) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/sessions/${session}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: recipient, message })
                });

                showNotification('Message sent successfully!', 'success');
                document.getElementById('messageText').value = '';
            } catch (error) {
                showNotification('Failed to send message', 'error');
            }
        }

        async function sendFile() {
            const session = document.getElementById('fileSession').value;
            const recipient = document.getElementById('fileRecipient').value.trim();
            const fileInput = document.getElementById('fileInput');
            const caption = document.getElementById('fileCaption').value.trim();

            if (!session || !recipient || !fileInput.files[0]) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('to', recipient);
                formData.append('caption', caption);

                showNotification('Uploading file...', 'info');

                await fetch(`${API_URL}/sessions/${session}/send-file`, {
                    method: 'POST',
                    body: formData
                });

                showNotification('File sent successfully!', 'success');
                fileInput.value = '';
                document.getElementById('fileCaption').value = '';
            } catch (error) {
                showNotification('Failed to send file', 'error');
            }
        }

        // Agent Management
        async function createAgent() {
            const session = document.getElementById('agentSession').value;
            const email = document.getElementById('agentEmail').value.trim();
            const name = document.getElementById('agentName').value.trim();
            const role = document.getElementById('agentRole').value;
            const maxConversations = document.getElementById('agentMaxConv').value;

            if (!session || !email || !name) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/sessions/${session}/agents`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, name, role, maxConversations })
                });

                showNotification('Agent added successfully!', 'success');
                document.getElementById('agentEmail').value = '';
                document.getElementById('agentName').value = '';
                loadAgents();
            } catch (error) {
                showNotification('Failed to add agent', 'error');
            }
        }

        async function loadAgents() {
            const session = document.getElementById('viewAgentsSession').value;
            if (!session) return;

            try {
                const response = await fetch(`${API_URL}/sessions/${session}/agents`);
                const data = await response.json();

                document.getElementById('agentsList').innerHTML = data.agents && data.agents.length > 0
                    ? data.agents.map(a => `
                        <div class="agent-item">
                            <h3>
                                <span class="agent-status status-${a.status}"></span>
                                ${a.name}
                            </h3>
                            <p>üìß ${a.email} | üé≠ ${a.role.toUpperCase()}</p>
                            <p>üìä Max Conversations: ${a.max_conversations}</p>
                            <div style="margin-top: 12px;">
                                <button class="btn-small btn-success" onclick="setAgentStatus('${session}', '${a.email}', 'online')">Online</button>
                                <button class="btn-small" style="background: #ff6a00;" onclick="setAgentStatus('${session}', '${a.email}', 'busy')">Busy</button>
                                <button class="btn-small" style="background: #6a6a8e;" onclick="setAgentStatus('${session}', '${a.email}', 'offline')">Offline</button>
                            </div>
                        </div>
                    `).join('')
                    : '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No agents found</p>';
            } catch (error) {
                console.error('Error loading agents:', error);
                showNotification('Failed to load agents', 'error');
            }
        }

        async function setAgentStatus(session, email, status) {
            try {
                await fetch(`${API_URL}/sessions/${session}/agents/${email}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                showNotification('Agent status updated', 'success');
                loadAgents();
            } catch (error) {
                showNotification('Failed to update status', 'error');
            }
        }

        async function addNote() {
            const session = document.getElementById('noteSession').value;
            const chatId = document.getElementById('noteChatId').value.trim();
            const agentEmail = document.getElementById('noteAgentEmail').value.trim();
            const note = document.getElementById('noteText').value.trim();
            const isPrivate = document.getElementById('notePrivate').checked;

            if (!session || !chatId || !agentEmail || !note) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/sessions/${session}/conversations/${chatId}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agentEmail, note, isPrivate })
                });

                showNotification('Note added successfully!', 'success');
                document.getElementById('noteText').value = '';
            } catch (error) {
                showNotification('Failed to add note', 'error');
            }
        }

        // Webhook Management
        async function createWebhook() {
            const session = document.getElementById('webhookSession').value;
            const url = document.getElementById('webhookUrl').value.trim();
            const eventsSelect = document.getElementById('webhookEvents');
            const events = Array.from(eventsSelect.selectedOptions).map(o => o.value);
            const secret = document.getElementById('webhookSecret').value.trim();

            if (!session || !url || events.length === 0) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            try {
                await fetch(`${API_URL}/sessions/${session}/webhooks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, events, secret })
                });

                showNotification('Webhook created successfully!', 'success');
                document.getElementById('webhookUrl').value = '';
                loadWebhooks();
            } catch (error) {
                showNotification('Failed to create webhook', 'error');
            }
        }

        async function loadWebhooks() {
            const session = document.getElementById('viewWebhooksSession').value;
            if (!session) return;

            try {
                const response = await fetch(`${API_URL}/sessions/${session}/webhooks`);
                const data = await response.json();

                document.getElementById('webhooksList').innerHTML = data.webhooks && data.webhooks.length > 0
                    ? data.webhooks.map(w => {
                        const events = JSON.parse(w.events);
                        return `
                            <div class="webhook-item">
                                <h3>üîó ${w.url}</h3>
                                <p><strong>Events:</strong> ${events.join(', ')}</p>
                                <p><strong>Status:</strong> ${w.enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</p>
                                <div style="margin-top: 12px;">
                                    <button class="btn-small btn-info" onclick="testWebhook('${session}', ${w.id})">Test</button>
                                    <button class="btn-small btn-danger" onclick="deleteWebhook('${session}', ${w.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No webhooks configured</p>';
            } catch (error) {
                console.error('Error loading webhooks:', error);
                showNotification('Failed to load webhooks', 'error');
            }
        }

        async function testWebhook(session, webhookId) {
            try {
                await fetch(`${API_URL}/sessions/${session}/webhooks/${webhookId}/test`, {
                    method: 'POST'
                });
                showNotification('Test webhook sent!', 'success');
            } catch (error) {
                showNotification('Failed to test webhook', 'error');
            }
        }

        async function deleteWebhook(session, webhookId) {
            if (!confirm('Are you sure you want to delete this webhook?')) return;

            try {
                await fetch(`${API_URL}/sessions/${session}/webhooks/${webhookId}`, {
                    method: 'DELETE'
                });
                showNotification('Webhook deleted', 'success');
                loadWebhooks();
            } catch (error) {
                showNotification('Failed to delete webhook', 'error');
            }
        }

        // CRM Integration
        async function syncToCRM() {
            const session = document.getElementById('crmSession').value;
            const contactId = document.getElementById('crmContactId').value.trim();
            const crmType = document.getElementById('crmType').value;

            if (!session || !contactId || !crmType) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            try {
                showNotification('Syncing to CRM...', 'info');
                await fetch(`${API_URL}/sessions/${session}/crm/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contactId, crmType, crmData: {} })
                });
                showNotification('Contact synced to CRM!', 'success');
            } catch (error) {
                showNotification('Failed to sync to CRM', 'error');
            }
        }

        async function bulkSyncToCRM() {
            const session = document.getElementById('bulkCrmSession').value;
            const crmType = document.getElementById('bulkCrmType').value;

            if (!session || !crmType) {
                showNotification('Please select session and CRM type', 'error');
                return;
            }

            if (!confirm('This will sync ALL contacts to your CRM. Continue?')) return;

            try {
                showNotification('Bulk syncing... This may take a while', 'info');
                const response = await fetch(`${API_URL}/sessions/${session}/crm/sync-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ crmType })
                });
                const data = await response.json();
                showNotification(`Synced ${data.synced}/${data.total} contacts. Failed: ${data.failed}`, 'success');
            } catch (error) {
                showNotification('Failed to bulk sync', 'error');
            }
        }

        async function loadCrmMappings() {
            const session = document.getElementById('viewCrmSession').value;
            if (!session) return;

            try {
                const response = await fetch(`${API_URL}/sessions/${session}/crm/mappings`);
                const data = await response.json();

                document.getElementById('crmMappingsList').innerHTML = data.mappings && data.mappings.length > 0
                    ? data.mappings.map(m => `
                        <div class="agent-item">
                            <h3>${m.contact_name || m.contact_id}</h3>
                            <p>üì± Phone: ${m.phone}</p>
                            <p>üîó CRM: ${m.crm_type.toUpperCase()} (${m.crm_contact_id})</p>
                            <p>üïê Last Synced: ${new Date(m.last_synced).toLocaleString()}</p>
                        </div>
                    `).join('')
                    : '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No CRM mappings found</p>';
            } catch (error) {
                console.error('Error loading CRM mappings:', error);
                showNotification('Failed to load CRM mappings', 'error');
            }
        }

        // Export Functions
        async function exportData(type, format) {
            let session, chatId;

            if (type === 'conversations') {
                session = document.getElementById('exportConvSession').value;
            } else if (type === 'messages') {
                session = document.getElementById('exportMsgSession').value;
                chatId = document.getElementById('exportChatId').value.trim();
            } else if (type === 'contacts') {
                session = document.getElementById('exportContactSession').value;
            }

            if (!session) {
                showNotification('Please select a session', 'error');
                return;
            }

            try {
                showNotification('Exporting data...', 'info');
                
                let url = `${API_URL}/sessions/${session}/export/${type}?format=${format}`;
                if (chatId) {
                    url += `&chatId=${chatId}`;
                }

                const response = await fetch(url);
                
                if (format === 'csv') {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `${type}-${session}-${Date.now()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    const data = await response.json();
                    const dataStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `${type}-${session}-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }

                showNotification('Export complete!', 'success');
            } catch (error) {
                console.error('Error exporting:', error);
                showNotification('Failed to export data', 'error');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
            setInterval(loadSessions, 10000);
        });
    </script>
</body>
</html> ANALYTICS TAB -->
        <div id="analytics-tab" class="tab-content active">
            <div class="card" style="margin-bottom: 24px;">
                <h2>üìä Overview Dashboard</h2>
                <div class="form-group">
                    <label>Select Session</label>
                    <select id="analyticsSession" onchange="loadAnalytics()">
                        <option value="">Choose a session...</option>
                    </select>
                </div>
                <div class="stats-grid" id="analyticsOverview">
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Total Messages</div>
                    </div>
                    <div class="stat-card" style="background: var(--gradient-success);">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Total Contacts</div>
                    </div>
                    <div class="stat-card" style="background: var(--gradient-info);">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Active Chats</div>
                    </div>
                    <div class="stat-card" style="background: var(--gradient-danger);">
                        <div class="stat-value">0s</div>
                        <div class="stat-label">Avg Response</div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card" style="grid-column: span 2;">
                    <h2>üìà Message Trends (30 Days)</h2>
                    <canvas id="messagesChart"></canvas>
                </div>

                <div class="card">
                    <h2>üèÜ Top Performers</h2>
                    <div id="agentPerformance" class="loading">Loading data...</div>
                </div>
            </div>
        </div>

        <!-- MESSAGING TAB -->
        <div id="messaging-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>‚ûï New Session</h2>
                    <div class="form-group">
                        <label>Session Name</label>
                        <input type="text" id="newSessionName" placeholder="e.g., sales-team">
                    </div>
                    <button onclick="createSession()">Create Session</button>
                </div>

                <div class="card">
                    <h2>üí¨ Send Message</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="messageSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Recipient</label>
                        <input type="text" id="recipientNumber" placeholder="201234567890@c.us">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="messageText" placeholder="Type your message..."></textarea>
                    </div>
                    <button onclick="sendMessage()">Send Message</button>
                </div>

                <div class="card">
                    <h2>üìé Send File</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="fileSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Recipient</label>
                        <input type="text" id="fileRecipient" placeholder="201234567890@c.us">
                    </div>
                    <div class="form-group">
                        <label>File</label>
                        <input type="file" id="fileInput">
                    </div>
                    <div class="form-group">
                        <label>Caption (Optional)</label>
                        <input type="text" id="fileCaption" placeholder="Add a caption">
                    </div>
                    <button onclick="sendFile()">Send File</button>
                </div>
            </div>
        </div>

        <!-- AGENTS TAB -->
        <div id="agents-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>‚ûï Add Team Member</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="agentSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="agentEmail" placeholder="agent@company.com">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="agentName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="agentRole">
                            <option value="agent">Agent</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max Conversations</label>
                        <input type="number" id="agentMaxConv" value="5" min="1" max="50">
                    </div>
                    <button onclick="createAgent()">Add Agent</button>
                </div>

                <div class="card" style="grid-column: span 2;">
                    <h2>üë• Team Directory</h2>
                    <div class="form-group">
                        <label>Select Session</label>
                        <select id="viewAgentsSession" onchange="loadAgents()">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div id="agentsList">No team members yet</div>
                </div>
            </div>

            <div class="card" style="margin-top: 24px;">
                <h2>üìù Internal Notes</h2>
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label>Session</label>
                            <select id="noteSession">
                                <option value="">Select session...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Chat ID</label>
                            <input type="text" id="noteChatId" placeholder="201234567890@c.us">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Agent Email</label>
                            <input type="email" id="noteAgentEmail" placeholder="agent@company.com">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notePrivate" style="width: auto; margin-right: 8px;">
                                Mark as Private
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Note Content</label>
                    <textarea id="noteText" placeholder="Add internal note..."></textarea>
                </div>
                <button onclick="addNote()">Add Note</button>
            </div>
        </div>

        <!-- WEBHOOKS TAB -->
        <div id="webhooks-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>‚ûï Create Webhook</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="webhookSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Webhook URL</label>
                        <input type="url" id="webhookUrl" placeholder="https://api.example.com/webhook">
                    </div>
                    <div class="form-group">
                        <label>Events</label>
                        <select id="webhookEvents" multiple size="6">
                            <option value="*">All Events</option>
                            <option value="message.received">Message Received</option>
                            <option value="message.sent">Message Sent</option>
                            <option value="session.connected">Session Connected</option>
                            <option value="session.disconnected">Session Disconnected</option>
                            <option value="conversation.assigned">Conversation Assigned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Secret Key (Optional)</label>
                        <input type="text" id="webhookSecret" placeholder="your-secret-key">
                    </div>
                    <button onclick="createWebhook()">Create Webhook</button>
                </div>

                <div class="card" style="grid-column: span 2;">
                    <h2>üîî Active Webhooks</h2>
                    <div class="form-group">
                        <label>Select Session</label>
                        <select id="viewWebhooksSession" onchange="loadWebhooks()">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div id="webhooksList">No webhooks configured</div>
                </div>
            </div>
        </div>

        <!-- CRM TAB -->
        <div id="crm-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üîó Sync Contact</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="crmSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contact ID</label>
                        <input type="text" id="crmContactId" placeholder="201234567890@c.us">
                    </div>
                    <div class="form-group">
                        <label>CRM Platform</label>
                        <select id="crmType">
                            <option value="salesforce">Salesforce</option>
                            <option value="hubspot">HubSpot</option>
                            <option value="zoho">Zoho CRM</option>
                            <option value="pipedrive">Pipedrive</option>
                            <option value="custom">Custom CRM</option>
                        </select>
                    </div>
                    <button onclick="syncToCRM()">Sync to CRM</button>
                </div>

                <div class="card">
                    <h2>üìä Bulk Operations</h2>
                    <div class="form-group">
                        <label>Session</label>
                        <select id="bulkCrmSession">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>CRM Platform</label>
                        <select id="bulkCrmType">
                            <option value="salesforce">Salesforce</option>
                            <option value="hubspot">HubSpot</option>
                            <option value="zoho">Zoho CRM</option>
                            <option value="pipedrive">Pipedrive</option>
                            <option value="custom">Custom CRM</option>
                        </select>
                    </div>
                    <button onclick="bulkSyncToCRM()" class="btn-success">Sync All Contacts</button>
                </div>

                <div class="card">
                    <h2>üìã CRM Mappings</h2>
                    <div class="form-group">
                        <label>Select Session</label>
                        <select id="viewCrmSession" onchange="loadCrmMappings()">
                            <option value="">Select session...</option>
                        </select>
                    </div>
                    <div id="crmMappingsList">No CRM mappings found</div>
                </div>
            </div>
        </div>

        <!--