<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - WPPConnect Agent</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <span class="brand-icon">üì±</span>
                <span class="brand-text">WPPConnect</span>
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="sessions.html" class="nav-item">
                    <span class="nav-icon">üí¨</span>
                    <span class="nav-text">Sessions</span>
                </a>
                <a href="messages.html" class="nav-item">
                    <span class="nav-icon">‚úâÔ∏è</span>
                    <span class="nav-text">Messages</span>
                </a>
                <a href="analytics.html" class="nav-item active">
                    <span class="nav-icon">üìà</span>
                    <span class="nav-text">Analytics</span>
                </a>
                <a href="backups.html" class="nav-item">
                    <span class="nav-icon">üíæ</span>
                    <span class="nav-text">Backups</span>
                </a>
                <a href="users.html" class="nav-item">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-text">Users</span>
                </a>
                <a href="tenants.html" class="nav-item">
                    <span class="nav-icon">üè¢</span>
                    <span class="nav-text">Tenants</span>
                </a>
                <a href="health.html" class="nav-item">
                    <span class="nav-icon">üè•</span>
                    <span class="nav-text">Health</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Settings</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role" id="userRole">admin</div>
                    </div>
                </div>
                <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1>Analytics</h1>
                    <p class="subtitle">Insights and performance metrics</p>
                </div>
                <div class="header-actions">
                    <select id="timeRangeFilter" class="input-select" onchange="loadAnalytics()">
                        <option value="today">Today</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    <button class="btn btn-primary" onclick="exportAnalytics()">
                        üì• Export Report
                    </button>
                </div>
            </header>

            <!-- Key Metrics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üí¨
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div class="stat-label">Total Messages</div>
                        <div class="stat-change positive" id="messagesChange">+0%</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        üì§
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="messagesSent">0</div>
                        <div class="stat-label">Messages Sent</div>
                        <div class="stat-change positive" id="sentChange">+0%</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        üì•
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="messagesReceived">0</div>
                        <div class="stat-label">Messages Received</div>
                        <div class="stat-change positive" id="receivedChange">+0%</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        ‚ö°
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="avgResponseTime">0s</div>
                        <div class="stat-label">Avg Response Time</div>
                        <div class="stat-change negative" id="responseChange">+0%</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2>Message Trends</h2>
                    </div>
                    <div class="card-body">
                        <canvas id="messageTrendsChart" height="200"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Session Activity</h2>
                    </div>
                    <div class="card-body">
                        <canvas id="sessionActivityChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Sessions Table -->
            <div class="card">
                <div class="card-header">
                    <h2>Top Sessions by Activity</h2>
                    <p class="subtitle">Most active WhatsApp sessions</p>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Session Name</th>
                                    <th>Messages Sent</th>
                                    <th>Messages Received</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="topSessionsTable">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="loading-spinner"></div>
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Log -->
            <div class="card">
                <div class="card-header">
                    <h2>Recent Activity</h2>
                    <p class="subtitle">Latest system events</p>
                </div>
                <div class="card-body">
                    <div class="activity-log" id="activityLog">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <p>Loading activity...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="js/app.js"></script>
    <script>
        let messageTrendsChart = null;
        let sessionActivityChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadUserInfo();
            loadAnalytics();

            // Refresh every 60 seconds
            setInterval(loadAnalytics, 60000);
        });

        async function loadAnalytics() {
            const timeRange = document.getElementById('timeRangeFilter').value;

            try {
                // Load dashboard metrics
                const metrics = await apiCall(`/analytics/dashboard?period=${timeRange}`);
                updateMetrics(metrics);

                // Load trends
                const trends = await apiCall(`/analytics/trends?period=${timeRange}`);
                updateCharts(trends);

                // Load top sessions
                await loadTopSessions();

                // Load activity log
                await loadActivityLog();

            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Failed to load analytics data', 'error');
            }
        }

        function updateMetrics(metrics) {
            // Update stat cards
            document.getElementById('totalMessages').textContent = formatNumber(metrics.totalMessages || 0);
            document.getElementById('messagesSent').textContent = formatNumber(metrics.messagesSent || 0);
            document.getElementById('messagesReceived').textContent = formatNumber(metrics.messagesReceived || 0);
            document.getElementById('avgResponseTime').textContent = (metrics.avgResponseTime || 0).toFixed(1) + 's';

            // Update change percentages (mock data for now)
            updateChange('messagesChange', metrics.messagesChange || 0);
            updateChange('sentChange', metrics.sentChange || 0);
            updateChange('receivedChange', metrics.receivedChange || 0);
            updateChange('responseChange', metrics.responseChange || 0);
        }

        function updateChange(elementId, value) {
            const element = document.getElementById(elementId);
            element.textContent = (value >= 0 ? '+' : '') + value + '%';
            element.className = 'stat-change ' + (value >= 0 ? 'positive' : 'negative');
        }

        function updateCharts(trends) {
            // Message Trends Chart
            const ctx1 = document.getElementById('messageTrendsChart').getContext('2d');

            if (messageTrendsChart) {
                messageTrendsChart.destroy();
            }

            messageTrendsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: trends.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'Sent',
                            data: trends.sent || [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Received',
                            data: trends.received || [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#38ef7d',
                            backgroundColor: 'rgba(56, 239, 125, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#b8b8d4'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#b8b8d4' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        x: {
                            ticks: { color: '#b8b8d4' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        }
                    }
                }
            });

            // Session Activity Chart
            const ctx2 = document.getElementById('sessionActivityChart').getContext('2d');

            if (sessionActivityChart) {
                sessionActivityChart.destroy();
            }

            sessionActivityChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Connected', 'Disconnected', 'QR Code', 'Error'],
                    datasets: [{
                        data: trends.sessionStatus || [0, 0, 0, 0],
                        backgroundColor: [
                            '#38ef7d',
                            '#6c757d',
                            '#ffa502',
                            '#ff4757'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#b8b8d4'
                            }
                        }
                    }
                }
            });
        }

        async function loadTopSessions() {
            try {
                const sessions = await apiCall('/sessions');
                const tbody = document.getElementById('topSessionsTable');

                if (!sessions.items || sessions.items.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center empty-state">
                                <div class="empty-icon">üì≠</div>
                                <p>No session data available</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Get stats for each session and sort by total messages
                const sessionsWithStats = [];
                for (const session of sessions.items) {
                    try {
                        const stats = await apiCall(`/sessions/${session.session_name}/stats`);
                        sessionsWithStats.push({
                            ...session,
                            stats
                        });
                    } catch (e) {
                        console.error(`Error loading stats for ${session.session_name}:`, e);
                    }
                }

                sessionsWithStats.sort((a, b) => {
                    const totalA = (a.stats?.messages_sent || 0) + (a.stats?.messages_received || 0);
                    const totalB = (b.stats?.messages_sent || 0) + (b.stats?.messages_received || 0);
                    return totalB - totalA;
                });

                tbody.innerHTML = sessionsWithStats.slice(0, 10).map(session => {
                    const sent = session.stats?.messages_sent || 0;
                    const received = session.stats?.messages_received || 0;
                    const total = sent + received;

                    return `
                        <tr>
                            <td><strong>${session.session_name}</strong></td>
                            <td>${formatNumber(sent)}</td>
                            <td>${formatNumber(received)}</td>
                            <td><strong>${formatNumber(total)}</strong></td>
                            <td><span class="badge badge-${getStatusClass(session.status)}">${session.status}</span></td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading top sessions:', error);
            }
        }

        async function loadActivityLog() {
            try {
                const activity = await apiCall('/analytics/activity?limit=20');
                const logContainer = document.getElementById('activityLog');

                if (!activity.items || activity.items.length === 0) {
                    logContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }

                logContainer.innerHTML = activity.items.map(item => `
                    <div class="activity-item">
                        <div class="activity-icon ${getActivityIconClass(item.event_type)}">
                            ${getActivityIcon(item.event_type)}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${item.event_type}</div>
                            <div class="activity-details">${item.details || ''}</div>
                        </div>
                        <div class="activity-time">${formatRelativeTime(item.timestamp)}</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading activity log:', error);
                // If activity endpoint doesn't exist, show placeholder
                document.getElementById('activityLog').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p>Activity tracking not available</p>
                    </div>
                `;
            }
        }

        function getStatusClass(status) {
            const statusMap = {
                'connected': 'success',
                'qr_code': 'warning',
                'connecting': 'info',
                'disconnected': 'default',
                'error': 'danger'
            };
            return statusMap[status] || 'default';
        }

        function getActivityIconClass(eventType) {
            const iconMap = {
                'session_created': 'success',
                'session_connected': 'success',
                'session_disconnected': 'warning',
                'message_sent': 'info',
                'message_received': 'info',
                'error': 'danger'
            };
            return iconMap[eventType] || 'default';
        }

        function getActivityIcon(eventType) {
            const iconMap = {
                'session_created': 'üì±',
                'session_connected': '‚úÖ',
                'session_disconnected': '‚ùå',
                'message_sent': 'üì§',
                'message_received': 'üì•',
                'error': '‚ö†Ô∏è'
            };
            return iconMap[eventType] || 'üìã';
        }

        async function exportAnalytics() {
            try {
                showToast('Exporting analytics report...', 'info');

                const timeRange = document.getElementById('timeRangeFilter').value;
                const metrics = await apiCall(`/analytics/dashboard?period=${timeRange}`);

                // Create CSV content
                let csv = 'Analytics Report\n\n';
                csv += 'Metric,Value\n';
                csv += `Total Messages,${metrics.totalMessages || 0}\n`;
                csv += `Messages Sent,${metrics.messagesSent || 0}\n`;
                csv += `Messages Received,${metrics.messagesReceived || 0}\n`;
                csv += `Avg Response Time,${(metrics.avgResponseTime || 0).toFixed(1)}s\n`;

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_${timeRange}_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();

                showToast('Report exported successfully!', 'success');

            } catch (error) {
                console.error('Error exporting analytics:', error);
                showToast('Failed to export report', 'error');
            }
        }
    </script>
</body>
</html>
